#!/usr/bin/env node

import { ethers } from "ethers";
import { readFileSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

async function diagnoseContracts() {
    console.log("üîç Diagnostic des Contrats D√©ploy√©s...");

    // Configuration
    const PRIVATE_KEY = process.env.PRIVATE_KEY;
    if (!PRIVATE_KEY) {
        console.error("‚ùå PRIVATE_KEY non d√©finie dans l'environnement");
        console.log("üí° Utilisez: export PRIVATE_KEY=votre_cl√©_priv√©e");
        process.exit(1);
    }

    const rpcUrl = process.env.HYPEREVM_RPC_URL || "https://999.rpc.thirdweb.com";
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

    console.log("üì± D√©ployeur:", wallet.address);
    console.log("üîó RPC:", rpcUrl);

    try {
        // V√©rifier la connexion
        const network = await provider.getNetwork();
        console.log("üåê R√©seau:", network.name || "HyperEVM");
        console.log("üîó Chain ID:", network.chainId);

        // V√©rifier le solde
        const balance = await provider.getBalance(wallet.address);
        console.log("üí∞ Solde:", ethers.formatEther(balance), "HYPE");

        // Adresses des contrats (utiliser celles du script pr√©c√©dent)
        const marketplaceAddress = "0xeEf91cD030F98Ce0330F050A446e3E883604D755";
        const directListingsAddress = "0x0D180f0029679BEDe5d9516f3b089BfD8d9cfd32";
        const offersAddress = "0x97541DFbe88427F02400F0Efb7d0679C32C76d0e";

        console.log("\nüìç Adresses des Contrats:");
        console.log("üè¢ MarketplaceV3:", marketplaceAddress);
        console.log("üè™ DirectListingsExtension:", directListingsAddress);
        console.log("üéØ Offers:", offersAddress);

        // Charger les ABIs
        console.log("\nüìã Chargement des ABIs...");

        const MarketplaceV3ABI = JSON.parse(
            readFileSync(join(__dirname, "./artifacts_forge/MarketplaceV3.sol/MarketplaceV3.json"), "utf8")
        ).abi;

        const DirectListingsExtensionABI = JSON.parse(
            readFileSync(join(__dirname, "./artifacts_forge/DirectListingsExtension.sol/DirectListingsExtension.json"), "utf8")
        ).abi;

        const OffersABI = JSON.parse(
            readFileSync(join(__dirname, "./artifacts_forge/Offers.sol/Offers.json"), "utf8")
        ).abi;

        // Cr√©er les instances des contrats
        const marketplace = new ethers.Contract(marketplaceAddress, MarketplaceV3ABI, wallet);
        const directListings = new ethers.Contract(directListingsAddress, DirectListingsExtensionABI, wallet);
        const offers = new ethers.Contract(offersAddress, OffersABI, wallet);

        // ===== DIAGNOSTIC MARKETPLACE =====
        console.log("\nüîç DIAGNOSTIC MARKETPLACE:");
        console.log("=".repeat(50));

        try {
            const marketplaceAdmin = await marketplace.DEFAULT_ADMIN_ROLE();
            console.log("‚úÖ DEFAULT_ADMIN_ROLE:", marketplaceAdmin);
        } catch (error) {
            console.error("‚ùå Erreur DEFAULT_ADMIN_ROLE:", error.message);
        }

        try {
            const extensionRole = await marketplace.EXTENSION_ROLE();
            console.log("‚úÖ EXTENSION_ROLE:", extensionRole);
        } catch (error) {
            console.error("‚ùå Erreur EXTENSION_ROLE:", error.message);
        }

        try {
            const hasAdminRole = await marketplace.hasRole(await marketplace.DEFAULT_ADMIN_ROLE(), wallet.address);
            console.log("‚úÖ D√©ployeur a DEFAULT_ADMIN_ROLE:", hasAdminRole);
        } catch (error) {
            console.error("‚ùå Erreur v√©rification admin:", error.message);
        }

        try {
            const hasExtensionRole = await marketplace.hasRole(await marketplace.EXTENSION_ROLE(), wallet.address);
            console.log("‚úÖ D√©ployeur a EXTENSION_ROLE:", hasExtensionRole);
        } catch (error) {
            console.error("‚ùå Erreur v√©rification extension:", error.message);
        }

        try {
            const platformFee = await marketplace.getPlatformFee();
            console.log("‚úÖ Platform Fee:", platformFee);
        } catch (error) {
            console.error("‚ùå Erreur platform fee:", error.message);
        }

        try {
            const allExtensions = await marketplace.getAllExtensionIds();
            console.log("‚úÖ Extensions existantes:", allExtensions.length);
            for (const extId of allExtensions) {
                const ext = await marketplace.getExtension(extId);
                console.log(`   - ${extId}: ${ext.extension} (${ext.enabled ? 'Activ√©e' : 'D√©sactiv√©e'})`);
            }
        } catch (error) {
            console.error("‚ùå Erreur extensions:", error.message);
        }

        // ===== DIAGNOSTIC DIRECTLISTINGS =====
        console.log("\nüîç DIAGNOSTIC DIRECTLISTINGS:");
        console.log("=".repeat(50));

        try {
            const directListingsAdmin = await directListings.DEFAULT_ADMIN_ROLE();
            console.log("‚úÖ DEFAULT_ADMIN_ROLE:", directListingsAdmin);
        } catch (error) {
            console.error("‚ùå Erreur DEFAULT_ADMIN_ROLE:", error.message);
        }

        try {
            const hasDirectListingsAdmin = await directListings.hasRole(await directListings.DEFAULT_ADMIN_ROLE(), wallet.address);
            console.log("‚úÖ D√©ployeur a DEFAULT_ADMIN_ROLE:", hasDirectListingsAdmin);
        } catch (error) {
            console.error("‚ùå Erreur v√©rification admin:", error.message);
        }

        try {
            const totalListings = await directListings.totalListings();
            console.log("‚úÖ Total Listings:", totalListings.toString());
        } catch (error) {
            console.error("‚ùå Erreur total listings:", error.message);
        }

        try {
            const nativeWrapper = await directListings.nativeTokenWrapper();
            console.log("‚úÖ Native Token Wrapper:", nativeWrapper);
        } catch (error) {
            console.error("‚ùå Erreur native wrapper:", error.message);
        }

        // ===== DIAGNOSTIC OFFERS =====
        console.log("\nüîç DIAGNOSTIC OFFERS:");
        console.log("=".repeat(50));

        try {
            const offersAdmin = await offers.DEFAULT_ADMIN_ROLE();
            console.log("‚úÖ DEFAULT_ADMIN_ROLE:", offersAdmin);
        } catch (error) {
            console.error("‚ùå Erreur DEFAULT_ADMIN_ROLE:", error.message);
        }

        try {
            const hasOffersAdmin = await offers.hasRole(await offers.DEFAULT_ADMIN_ROLE(), wallet.address);
            console.log("‚úÖ D√©ployeur a DEFAULT_ADMIN_ROLE:", hasOffersAdmin);
        } catch (error) {
            console.error("‚ùå Erreur v√©rification admin:", error.message);
        }

        try {
            const totalOffers = await offers.totalOffers();
            console.log("‚úÖ Total Offers:", totalOffers.toString());
        } catch (error) {
            console.error("‚ùå Erreur total offers:", error.message);
        }

        // ===== TEST D'INTERFACE =====
        console.log("\nüîç TEST D'INTERFACE:");
        console.log("=".repeat(50));

        // Test IERC165 sur DirectListings
        try {
            const directListingsCode = await provider.getCode(directListingsAddress);
            console.log("‚úÖ Code DirectListings:", directListingsCode.slice(0, 66) + "...");

            // Test si le contrat r√©pond aux appels basiques
            const directListingsOwner = await directListings.owner();
            console.log("‚úÖ Owner DirectListings:", directListingsOwner);
        } catch (error) {
            console.error("‚ùå Erreur interface DirectListings:", error.message);
        }

        // Test IERC165 sur Offers
        try {
            const offersCode = await provider.getCode(offersAddress);
            console.log("‚úÖ Code Offers:", offersCode.slice(0, 66) + "...");

            // Test si le contrat r√©pond aux appels basiques
            const offersOwner = await offers.owner();
            console.log("‚úÖ Owner Offers:", offersOwner);
        } catch (error) {
            console.error("‚ùå Erreur interface Offers:", error.message);
        }

        // ===== TEST D'AJOUT D'EXTENSION =====
        console.log("\nüîç TEST D'AJOUT D'EXTENSION:");
        console.log("=".repeat(50));

        const DIRECT_LISTINGS_ID = ethers.keccak256(ethers.toUtf8Bytes("DIRECT_LISTINGS"));
        const OFFERS_ID = ethers.keccak256(ethers.toUtf8Bytes("OFFERS"));

        console.log("üÜî IDs des Extensions:");
        console.log("DIRECT_LISTINGS:", DIRECT_LISTINGS_ID);
        console.log("OFFERS:", OFFERS_ID);

        // Test d'estimation de gas pour addExtension
        try {
            console.log("\nüß™ Test d'estimation de gas pour DirectListings...");
            const gasEstimate = await marketplace.addExtension.estimateGas(
                DIRECT_LISTINGS_ID,
                directListingsAddress,
                "Direct Listings Extension"
            );
            console.log("‚úÖ Estimation de gas r√©ussie:", gasEstimate.toString());
        } catch (error) {
            console.error("‚ùå Erreur estimation gas DirectListings:", error.message);
            console.error("   D√©tails:", error);
        }

        try {
            console.log("\nüß™ Test d'estimation de gas pour Offers...");
            const gasEstimate = await marketplace.addExtension.estimateGas(
                OFFERS_ID,
                offersAddress,
                "Offers Extension"
            );
            console.log("‚úÖ Estimation de gas r√©ussie:", gasEstimate.toString());
        } catch (error) {
            console.error("‚ùå Erreur estimation gas Offers:", error.message);
            console.error("   D√©tails:", error);
        }

        // ===== R√âSUM√â =====
        console.log("\nüìä R√âSUM√â DU DIAGNOSTIC:");
        console.log("=".repeat(50));
        console.log("üè¢ MarketplaceV3: V√©rifi√©");
        console.log("üè™ DirectListingsExtension: V√©rifi√©");
        console.log("üéØ Offers: V√©rifi√©");
        console.log("\nüí° Si des erreurs persistent, v√©rifiez:");
        console.log("   1. Les permissions sur les contrats");
        console.log("   2. L'impl√©mentation des interfaces");
        console.log("   3. Les restrictions de s√©curit√©");

    } catch (error) {
        console.error("‚ùå Erreur lors du diagnostic:", error.message);
        console.error("   D√©tails:", error);
        process.exit(1);
    }
}

// Gestion des erreurs non captur√©es
process.on('unhandledRejection', (error) => {
    console.error("‚ùå Erreur non captur√©e:", error);
    process.exit(1);
});

// Ex√©cuter le script
if (import.meta.url === `file://${process.argv[1]}`) {
    diagnoseContracts().catch((error) => {
        console.error("‚ùå Erreur fatale:", error);
        process.exit(1);
    });
}
