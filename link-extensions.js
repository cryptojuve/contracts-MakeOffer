#!/usr/bin/env node

import { ethers } from "ethers";
import { readFileSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

async function linkExtensions() {
    console.log("üîó Liaison des Extensions √† la Marketplace...");

    // Configuration
    const PRIVATE_KEY = process.env.PRIVATE_KEY;
    if (!PRIVATE_KEY) {
        console.error("‚ùå PRIVATE_KEY non d√©finie dans l'environnement");
        console.log("üí° Utilisez: export PRIVATE_KEY=votre_cl√©_priv√©e");
        process.exit(1);
    }

    const rpcUrl = process.env.HYPEREVM_RPC_URL || "https://999.rpc.thirdweb.com";
    const provider = new ethers.JsonRpcProvider(rpcUrl);
    const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

    console.log("üì± D√©ployeur:", wallet.address);
    console.log("üîó RPC:", rpcUrl);

    try {
        // V√©rifier la connexion
        const network = await provider.getNetwork();
        console.log("üåê R√©seau:", network.name || "HyperEVM");
        console.log("üîó Chain ID:", network.chainId);

        // V√©rifier le solde
        const balance = await provider.getBalance(wallet.address);
        console.log("üí∞ Solde:", ethers.formatEther(balance), "HYPE");

        if (balance === 0n) {
            console.error("‚ùå Solde insuffisant pour les transactions");
            process.exit(1);
        }

        // Charger les ABIs des contrats
        console.log("\nüìã Chargement des ABIs...");

        const MarketplaceV3ABI = JSON.parse(
            readFileSync(join(__dirname, "./artifacts_forge/MarketplaceV3.sol/MarketplaceV3.json"), "utf8")
        ).abi;

        const DirectListingsExtensionABI = JSON.parse(
            readFileSync(join(__dirname, "./artifacts_forge/DirectListingsExtension.sol/DirectListingsExtension.json"), "utf8")
        ).abi;

        const OffersABI = JSON.parse(
            readFileSync(join(__dirname, "./artifacts_forge/Offers.sol/Offers.json"), "utf8")
        ).abi;

        // Demander les adresses des contrats d√©ploy√©s
        console.log("\nüìù Configuration des Adresses de Contrats:");
        console.log("üí° Entrez les adresses des contrats d√©j√† d√©ploy√©s");

        const marketplaceAddress = process.env.MARKETPLACE_ADDRESS || await askForAddress("MarketplaceV3");
        const directListingsAddress = process.env.DIRECTLISTINGS_ADDRESS || await askForAddress("DirectListingsExtension");
        const offersAddress = process.env.OFFERS_ADDRESS || await askForAddress("Offers");

        console.log("\nüìç Adresses des Contrats:");
        console.log("üè¢ MarketplaceV3:", marketplaceAddress);
        console.log("üè™ DirectListingsExtension:", directListingsAddress);
        console.log("üéØ Offers:", offersAddress);

        // Cr√©er les instances des contrats
        const marketplace = new ethers.Contract(marketplaceAddress, MarketplaceV3ABI, wallet);
        const directListings = new ethers.Contract(directListingsAddress, DirectListingsExtensionABI, wallet);
        const offers = new ethers.Contract(offersAddress, OffersABI, wallet);

        // V√©rifier que les contrats existent
        console.log("\nüîç V√©rification des contrats...");

        try {
            const marketplaceAdmin = await marketplace.DEFAULT_ADMIN_ROLE();
            console.log("‚úÖ MarketplaceV3 v√©rifi√©");
        } catch (error) {
            console.error("‚ùå Erreur avec MarketplaceV3:", error.message);
            process.exit(1);
        }

        try {
            const directListingsAdmin = await directListings.DEFAULT_ADMIN_ROLE();
            console.log("‚úÖ DirectListingsExtension v√©rifi√©");
        } catch (error) {
            console.error("‚ùå Erreur avec DirectListingsExtension:", error.message);
            process.exit(1);
        }

        try {
            const offersAdmin = await offers.DEFAULT_ADMIN_ROLE();
            console.log("‚úÖ Offers v√©rifi√©");
        } catch (error) {
            console.error("‚ùå Erreur avec Offers:", error.message);
            process.exit(1);
        }

        // V√©rifier les permissions sur la marketplace
        console.log("\nüîê V√©rification des permissions...");

        const EXTENSION_ROLE = await marketplace.EXTENSION_ROLE();
        const hasExtensionRole = await marketplace.hasRole(EXTENSION_ROLE, wallet.address);

        if (!hasExtensionRole) {
            console.error("‚ùå Vous n'avez pas le r√¥le EXTENSION_ROLE sur la marketplace");
            console.log("üí° Contactez l'administrateur de la marketplace");
            process.exit(1);
        }

        console.log("‚úÖ Permissions v√©rifi√©es (EXTENSION_ROLE)");

        // D√©finir les IDs des extensions
        const DIRECT_LISTINGS_ID = ethers.keccak256(ethers.toUtf8Bytes("DIRECT_LISTINGS"));
        const OFFERS_ID = ethers.keccak256(ethers.toUtf8Bytes("OFFERS"));

        console.log("\nüÜî IDs des Extensions:");
        console.log("DIRECT_LISTINGS:", DIRECT_LISTINGS_ID);
        console.log("OFFERS:", OFFERS_ID);

        // V√©rifier si les extensions sont d√©j√† enregistr√©es
        console.log("\nüîç V√©rification des extensions existantes...");

        try {
            const existingDirectListings = await marketplace.getExtension(DIRECT_LISTINGS_ID);
            if (existingDirectListings.extension !== ethers.ZeroAddress) {
                console.log("‚ö†Ô∏è  DirectListingsExtension d√©j√† enregistr√©e");
                console.log("   Adresse:", existingDirectListings.extension);
                console.log("   Activ√©e:", existingDirectListings.enabled);
            } else {
                console.log("‚ÑπÔ∏è  DirectListingsExtension non enregistr√©e");
            }
        } catch (error) {
            console.log("‚ÑπÔ∏è  DirectListingsExtension non enregistr√©e");
        }

        try {
            const existingOffers = await marketplace.getExtension(OFFERS_ID);
            if (existingOffers.extension !== ethers.ZeroAddress) {
                console.log("‚ö†Ô∏è  Offers d√©j√† enregistr√©e");
                console.log("   Adresse:", existingOffers.extension);
                console.log("   Activ√©e:", existingOffers.enabled);
            } else {
                console.log("‚ÑπÔ∏è  Offers non enregistr√©e");
            }
        } catch (error) {
            console.log("‚ÑπÔ∏è  Offers non enregistr√©e");
        }

        // Demander confirmation
        console.log("\n‚ö†Ô∏è  ATTENTION: Cette op√©ration va lier les extensions √† la marketplace");
        console.log("üìã Actions qui seront effectu√©es:");
        console.log("   1. Enregistrer DirectListingsExtension");
        console.log("   2. Enregistrer Offers");
        console.log("   3. V√©rifier les liaisons");

        const confirm = process.env.CONFIRM || await askForConfirmation("Continuer ? (oui/non)");
        if (confirm.toLowerCase() !== 'oui' && confirm.toLowerCase() !== 'yes') {
            console.log("‚ùå Op√©ration annul√©e");
            process.exit(0);
        }

        // Enregistrer DirectListingsExtension
        console.log("\nüè™ Enregistrement de DirectListingsExtension...");
        try {
            const tx1 = await marketplace.addExtension(
                DIRECT_LISTINGS_ID,
                directListingsAddress,
                "Direct Listings Extension"
            );
            console.log("‚è≥ Transaction envoy√©e:", tx1.hash);
            await tx1.wait();
            console.log("‚úÖ DirectListingsExtension enregistr√©e avec succ√®s");
        } catch (error) {
            console.error("‚ùå Erreur lors de l'enregistrement de DirectListingsExtension:", error.message);
            process.exit(1);
        }

        // Enregistrer Offers
        console.log("\nüéØ Enregistrement de Offers...");
        try {
            const tx2 = await marketplace.addExtension(
                OFFERS_ID,
                offersAddress,
                "Offers Extension"
            );
            console.log("‚è≥ Transaction envoy√©e:", tx2.hash);
            await tx2.wait();
            console.log("‚úÖ Offers enregistr√©e avec succ√®s");
        } catch (error) {
            console.error("‚ùå Erreur lors de l'enregistrement de Offers:", error.message);
            process.exit(1);
        }

        // V√©rifier les liaisons
        console.log("\nüîç V√©rification des liaisons...");

        try {
            const directListingsExt = await marketplace.getExtension(DIRECT_LISTINGS_ID);
            console.log("‚úÖ DirectListingsExtension v√©rifi√©e:");
            console.log("   Adresse:", directListingsExt.extension);
            console.log("   Activ√©e:", directListingsExt.enabled);
            console.log("   Nom:", directListingsExt.name);
        } catch (error) {
            console.error("‚ùå Erreur lors de la v√©rification de DirectListingsExtension:", error.message);
        }

        try {
            const offersExt = await marketplace.getExtension(OFFERS_ID);
            console.log("‚úÖ Offers v√©rifi√©e:");
            console.log("   Adresse:", offersExt.extension);
            console.log("   Activ√©e:", offersExt.enabled);
            console.log("   Nom:", offersExt.name);
        } catch (error) {
            console.error("‚ùå Erreur lors de la v√©rification de Offers:", error.message);
        }

        // Lister toutes les extensions
        console.log("\nüìã Toutes les extensions enregistr√©es:");
        try {
            const allExtensionIds = await marketplace.getAllExtensionIds();
            for (const extensionId of allExtensionIds) {
                const extension = await marketplace.getExtension(extensionId);
                console.log(`   - ${extension.name}: ${extension.extension} (${extension.enabled ? 'Activ√©e' : 'D√©sactiv√©e'})`);
            }
        } catch (error) {
            console.error("‚ùå Erreur lors de la r√©cup√©ration des extensions:", error.message);
        }

        console.log("\nüéâ Liaison des extensions termin√©e avec succ√®s !");
        console.log("\nüìä R√©sum√©:");
        console.log("üè¢ MarketplaceV3:", marketplaceAddress);
        console.log("üè™ DirectListingsExtension:", directListingsAddress);
        console.log("üéØ Offers:", offersAddress);
        console.log("\nüîó Les extensions sont maintenant li√©es et op√©rationnelles !");

    } catch (error) {
        console.error("‚ùå Erreur lors de la liaison des extensions:", error.message);
        process.exit(1);
    }
}

// Fonction utilitaire pour demander une adresse
async function askForAddress(contractName) {
    // En mode non-interactif, utiliser une adresse par d√©faut
    if (process.env.NODE_ENV === 'production') {
        return "0x0000000000000000000000000000000000000000";
    }

    // En mode interactif, demander √† l'utilisateur
    const readline = await import('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    return new Promise((resolve) => {
        rl.question(`Entrez l'adresse de ${contractName}: `, (answer) => {
            rl.close();
            resolve(answer.trim());
        });
    });
}

// Fonction utilitaire pour demander confirmation
async function askForConfirmation(message) {
    if (process.env.NODE_ENV === 'production') {
        return 'oui';
    }

    const readline = await import('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    return new Promise((resolve) => {
        rl.question(`${message} `, (answer) => {
            rl.close();
            resolve(answer.trim());
        });
    });
}

// Gestion des erreurs non captur√©es
process.on('unhandledRejection', (error) => {
    console.error("‚ùå Erreur non captur√©e:", error);
    process.exit(1);
});

// Ex√©cuter le script
if (import.meta.url === `file://${process.argv[1]}`) {
    linkExtensions().catch((error) => {
        console.error("‚ùå Erreur fatale:", error);
        process.exit(1);
    });
}
